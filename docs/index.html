<html><head><title>finatra common practice</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="docs" /><meta name="description" content="Guideline for common practice in finatra 2.11" /><meta name="og:image" content="/finatra-common-practice/img/poster.png" /><meta name="og:title" content="finatra common practice" /><meta name="og:site_name" content="finatra common practice" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Guideline for common practice in finatra 2.11" /><link rel="icon" type="image/png" href="/finatra-common-practice/img/favicon.png" /><meta name="twitter:title" content="finatra common practice" /><meta name="twitter:image" content="img/poster.png" /><meta name="twitter:description" content="Guideline for common practice in finatra 2.11" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/finatra-common-practice/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/finatra-common-practice/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/finatra-common-practice/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/finatra-common-practice/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/finatra-common-practice/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/finatra-common-practice/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/finatra-common-practice/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/finatra-common-practice/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/finatra-common-practice/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/finatra-common-practice/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/finatra-common-practice/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/finatra-common-practice/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/finatra-common-practice/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/finatra-common-practice/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/finatra-common-practice/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/finatra-common-practice/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/finatra-common-practice/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/finatra-common-practice/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/finatra-common-practice/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/finatra-common-practice/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/finatra-common-practice/highlight/styles/github.css" /><link rel="stylesheet" href="/finatra-common-practice/css/style.css" /><link rel="stylesheet" href="/finatra-common-practice/css/palette.css" /><link rel="stylesheet" href="/finatra-common-practice/css/codemirror.css" /><link rel="stylesheet" href="/finatra-common-practice/css/kazari-style.css" /><link rel="stylesheet" href="/finatra-common-practice/css/monokai.css" /><link rel="stylesheet" href="/finatra-common-practice/css/override.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/finatra-common-practice/" class="brand"><div class="brand-wrapper"><span>finatra common practice</span></div></a></li> <li><a href="/finatra-common-practice/docs/index.html" class=" active ">Introduction</a></li> <li><a href="/finatra-common-practice/docs/pipe-operator.html" class="">Pipe Operator</a></li> <li><a href="/finatra-common-practice/docs/input-validation.html" class="">Input Validation</a></li> <li><a href="/finatra-common-practice/docs/http-client.html" class="">Http Client</a></li> <li><a href="/finatra-common-practice/docs/errors-and-http-response.html" class="">Errors and Http Response</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/jamesyang124/finatra-common-practice"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/jamesyang124/finatra-common-practice"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('finatra common practice Guideline for common practice in finatra 2.11');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('finatra common practice Guideline for common practice in finatra 2.11');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="jamesyang124" data-github-repo="finatra-common-practice"><div class="content-wrapper"><section><h1 id="finagle">Finagle</h1>

<p>Finatra is a RPC framework based on <a href="https://twitter.github.io/finagle/guide/">Finagle</a> and <strong>TwitterServer</strong> module. It takes the role for JSON request/response processing. It also integrate popular <code class="highlighter-rouge">scala-test</code> test framework to help developers start their TDD as soon as possible. It is essential components are <code class="highlighter-rouge">controller</code> and <code class="highlighter-rouge">service</code>. Both of it are passed into twitter future context therefore the client request processing is asynchronous by default.</p>

<p>Here is an introduction for the finagle and future based event processing:</p>

<p><a href="https://youtu.be/kfs-dtbG0kY">Finagle Under the Hood - by Vladimir Kostyukov</a></p>

<p>In rest of the document, we will introducing the common practice for each pieces of <strong>controller</strong>, <strong>service</strong>, <strong>http client</strong>, <strong>request/response handling</strong>, and <strong>input validation</strong>.</p>

<h2 id="controller">Controller</h2>

<p>Controller require each response should be wrapped in twitter future, then finatra will dispatch it down to netty request processing. Controller is usually implemented for following principle:</p>

<ol>
  <li>Only handle request and response.</li>
  <li>Compose proper types for services from input request.</li>
  <li>Compose proper response for clients from internal service response.</li>
  <li>Dispatch validated request to the internal services.</li>
  <li>Wrapped service layer error to proper Http error response.</li>
  <li>Support API document for external service integration.</li>
</ol>

<p>Common case of a controller will be like this:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">package</span> <span class="nn">service.controllers.email</span>

<span class="nd">@Singleton</span>
<span class="k">class</span> <span class="nc">EmailSignUpController</span> <span class="nd">@Inject</span><span class="o">()(</span><span class="k">implicit</span> <span class="k">protected</span> <span class="k">val</span> <span class="n">swagger</span><span class="k">:</span> <span class="kt">Swagger</span><span class="o">,</span> <span class="n">emailSignUpService</span><span class="k">:</span> <span class="kt">EmailSignUpService</span><span class="o">)</span>
    <span class="k">extends</span> <span class="nc">SwaggerController</span> <span class="o">{</span>

  <span class="n">postWithDoc</span><span class="o">(</span><span class="s">"/api/service/v1/mobile/email/create"</span><span class="o">)(</span><span class="n">createEmailAccountDoc</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">r</span><span class="k">:</span> <span class="kt">MobileEmailSignUpRequest</span> <span class="o">=&gt;</span>
      <span class="n">emailSignUpService</span><span class="o">(</span><span class="n">r</span><span class="o">).</span><span class="n">map</span><span class="o">({</span>
        <span class="k">case</span> <span class="nc">OK</span><span class="o">(</span><span class="k">_</span><span class="o">)</span>               <span class="k">=&gt;</span> <span class="n">response</span><span class="o">.</span><span class="n">noContent</span>
        <span class="k">case</span> <span class="nc">KO</span><span class="o">(</span><span class="nc">Errors</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="n">e</span><span class="o">)))</span> <span class="k">=&gt;</span> <span class="n">errorsToHttpResponse</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
      <span class="o">})</span>
  <span class="o">}</span>

  <span class="n">postWithDoc</span><span class="o">(</span><span class="s">"/api/service/v1/desktop/email/create"</span><span class="o">)(</span><span class="n">createEmailAccountDoc</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">r</span><span class="k">:</span> <span class="kt">DesktopEmailSignUpRequest</span> <span class="o">=&gt;</span>
      <span class="n">emailSignUpService</span><span class="o">(</span><span class="n">r</span><span class="o">).</span><span class="n">map</span><span class="o">({</span>
        <span class="k">case</span> <span class="nc">OK</span><span class="o">(</span><span class="k">_</span><span class="o">)</span>               <span class="k">=&gt;</span> <span class="n">response</span><span class="o">.</span><span class="n">noContent</span>
        <span class="k">case</span> <span class="nc">KO</span><span class="o">(</span><span class="nc">Errors</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="n">e</span><span class="o">)))</span> <span class="k">=&gt;</span> <span class="n">errorsToHttpResponse</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
      <span class="o">})</span>
  <span class="o">}</span>

  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">def</span> <span class="n">errorsToHttpResponse</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">ErrorBase</span><span class="o">)</span> <span class="k">=</span> <span class="n">e</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">EmailIsUsedError</span> <span class="k">=&gt;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">conflict</span><span class="o">.</span><span class="n">json</span><span class="o">(</span><span class="nc">EmailAccountExistedControllerError</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">CaptchaServiceBadRequestError</span> <span class="k">=&gt;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">badRequest</span><span class="o">.</span><span class="n">json</span><span class="o">(</span><span class="nc">InvalidCaptchaControllerError</span><span class="o">)</span>
    <span class="k">case</span> <span class="n">t</span> <span class="k">@</span> <span class="k">_</span> <span class="k">=&gt;</span>
      <span class="n">error</span><span class="o">(</span><span class="n">s</span><span class="s">"[EmailSignUpController] email sign up internal service dependency error $t"</span><span class="o">)</span>
      <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="o">(</span><span class="nc">Status</span><span class="o">.</span><span class="nc">FailedDependency</span><span class="o">).</span><span class="n">json</span><span class="o">(</span><span class="n">t</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Notice that the description of swagger document is drag out to same package level object <code class="highlighter-rouge">SwaggerDocument</code>:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">package</span> <span class="nn">service.controllers.email</span>

<span class="k">object</span> <span class="nc">SwaggerDocument</span> <span class="o">{</span>
  <span class="k">private</span><span class="o">[</span><span class="kt">email</span><span class="o">]</span> <span class="k">val</span> <span class="n">createEmailAccountDoc</span><span class="k">:</span> <span class="kt">Operation</span> <span class="o">=&gt;</span> <span class="nc">Operation</span> <span class="k">=</span> <span class="o">{</span> <span class="n">o</span> <span class="k">=&gt;</span>
    <span class="n">o</span><span class="o">.</span><span class="n">tag</span><span class="o">(</span><span class="s">"create email account"</span><span class="o">)</span>
      <span class="o">.</span><span class="n">summary</span><span class="o">(</span><span class="s">"create for email account"</span><span class="o">)</span>
      <span class="o">.</span><span class="n">description</span><span class="o">(</span><span class="s">"create for email account."</span><span class="o">)</span>
      <span class="o">.</span><span class="n">consumes</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">)</span>
      <span class="o">.</span><span class="n">produces</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">)</span>
      <span class="o">.</span><span class="n">response</span><span class="o">(</span><span class="nc">InternalServerError</span><span class="o">.</span><span class="n">code</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">().</span><span class="n">description</span><span class="o">(</span><span class="nc">InternalServerError</span><span class="o">.</span><span class="n">reason</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="k">private</span><span class="o">[</span><span class="kt">email</span><span class="o">]</span> <span class="k">val</span> <span class="n">emailSignUpDoc</span><span class="k">:</span> <span class="kt">Operation</span> <span class="o">=&gt;</span> <span class="nc">Operation</span> <span class="k">=</span> <span class="o">{</span> <span class="n">o</span> <span class="k">=&gt;</span>
    <span class="n">o</span><span class="o">.</span><span class="n">tag</span><span class="o">(</span><span class="s">"..."</span><span class="o">)</span>
      <span class="o">.</span><span class="n">summary</span><span class="o">(</span><span class="s">"sign up email account"</span><span class="o">)</span>
      <span class="o">.</span><span class="n">description</span><span class="o">(</span><span class="s">"..."</span><span class="o">)</span>
      <span class="o">.</span><span class="n">consumes</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">)</span>
      <span class="o">.</span><span class="n">produces</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">)</span>
      <span class="o">.</span><span class="n">response</span><span class="o">(</span><span class="nc">InternalServerError</span><span class="o">.</span><span class="n">code</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">().</span><span class="n">description</span><span class="o">(</span><span class="nc">InternalServerError</span><span class="o">.</span><span class="n">reason</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The service are injected by Scala extension for Google’s juice injection - <a href="https://github.com/codingwell/scala-guice">https://github.com/codingwell/scala-guice</a></p>

<p>We separate the http response handling to <code class="highlighter-rouge">errorsToHttpResponse</code> method which convert output response from <code class="highlighter-rouge">ErrorBase</code> inherited errors. So the <code class="highlighter-rouge">postWithDoc</code> controller method provide concrete purpose for API readability:</p>

<blockquote>
  <p>Controller should only focus on the functionality of request/response transformation, service dispatching, and API document injection.</p>
</blockquote>

<h2 id="service">Service</h2>

<p>Service may handle the application logic or gluing other services for the composition. Basically each service should take single duty for DRY principle. And the higer abstraction level services orchestra single duty services to a larger service unit to fulfill business or application requirement.</p>

<p>A common single duty service will be very similar like this:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="nd">@Singleton</span>
<span class="k">class</span> <span class="nc">TokenVerificationService</span> <span class="nd">@Inject</span><span class="o">()(</span><span class="n">serviceClients</span><span class="k">:</span> <span class="kt">ServiceClients</span><span class="o">,</span> <span class="n">mapper</span><span class="k">:</span> <span class="kt">FinatraObjectMapper</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Logging</span> <span class="o">{</span>

  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">def</span> <span class="n">issueVerification</span><span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">TokenVerificationRequest</span><span class="o">,</span> <span class="n">validateResponse</span><span class="k">:</span> <span class="kt">Response</span> <span class="o">=&gt;</span> <span class="nc">Maybe</span><span class="o">[</span><span class="kt">Response</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">post</span><span class="o">(</span><span class="s">"/verify/v1/issue"</span><span class="o">)</span>
      <span class="o">.</span><span class="n">header</span><span class="o">(</span><span class="nc">HttpHeaders</span><span class="o">.</span><span class="nc">ContentType</span><span class="o">,</span> <span class="nc">ContentType</span><span class="o">.</span><span class="nc">JSON</span><span class="o">.</span><span class="n">contentTypeName</span><span class="o">)</span>
      <span class="o">.</span><span class="n">body</span><span class="o">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">writeValueAsString</span><span class="o">(</span><span class="n">r</span><span class="o">))</span>
      <span class="o">.|&gt;(</span><span class="n">req</span> <span class="k">=&gt;</span> <span class="n">serviceClients</span><span class="o">.</span><span class="n">executeVerificationHttpClient</span><span class="o">(</span><span class="n">req</span><span class="o">)(</span><span class="n">validateResponse</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">def</span> <span class="n">responseHandling</span><span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">Response</span><span class="o">)</span><span class="k">:</span> <span class="kt">Maybe</span><span class="o">[</span><span class="kt">Response</span><span class="o">]</span> <span class="k">=</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Status</span><span class="o">.</span><span class="nc">Ok</span>           <span class="k">=&gt;</span> <span class="nc">OK</span><span class="o">(</span><span class="n">r</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">Status</span><span class="o">.</span><span class="nc">BadRequest</span>   <span class="k">=&gt;</span> <span class="nc">KO</span><span class="o">(</span><span class="nc">Errors</span><span class="o">(</span><span class="nc">VerificationServiceBadRequestError</span><span class="o">))</span>
    <span class="k">case</span> <span class="nc">Status</span><span class="o">.</span><span class="nc">Unauthorized</span> <span class="k">=&gt;</span> <span class="nc">KO</span><span class="o">(</span><span class="nc">Errors</span><span class="o">(</span><span class="nc">VerificationServiceUnauthorizedError</span><span class="o">))</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
      <span class="n">error</span><span class="o">(</span><span class="n">s</span><span class="s">"verification service respond with invalid HTTP status code - response: $r"</span><span class="o">)</span>
      <span class="nc">KO</span><span class="o">(</span><span class="nc">Errors</span><span class="o">(</span><span class="nc">VerificationServiceResponseError</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">def</span> <span class="n">parseResponse</span><span class="o">(</span><span class="n">resp</span><span class="k">:</span> <span class="kt">Response</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">Try</span><span class="o">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">parse</span><span class="o">[</span><span class="kt">TokenVerificationResponse</span><span class="o">](</span><span class="n">resp</span><span class="o">.</span><span class="n">contentString</span><span class="o">))</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Return</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">(</span><span class="nc">OK</span><span class="o">(</span><span class="n">x</span><span class="o">))</span>
      <span class="k">case</span> <span class="nc">Throw</span><span class="o">(</span><span class="n">t</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">error</span><span class="o">(</span><span class="n">s</span><span class="s">"finatra object mapper parse response failed - response: $resp | exception: $t"</span><span class="o">)</span>
        <span class="nc">Future</span><span class="o">(</span><span class="nc">KO</span><span class="o">(</span><span class="nc">Errors</span><span class="o">(</span><span class="nc">TokenVerificationResponseParseError</span><span class="o">)))</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">TokenVerificationRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Maybe</span><span class="o">[</span><span class="kt">TokenVerificationResponse</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="o">(</span><span class="k">for</span> <span class="o">{</span>
      <span class="n">rawResponse</span> <span class="k">&lt;-</span> <span class="nc">FutureEither</span><span class="o">(</span><span class="n">issueVerification</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">responseHandling</span><span class="o">))</span>
      <span class="n">resp</span>        <span class="k">&lt;-</span> <span class="nc">FutureEither</span><span class="o">(</span><span class="n">parseResponse</span><span class="o">(</span><span class="n">rawResponse</span><span class="o">))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">resp</span><span class="o">).</span><span class="n">future</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">|&gt;</code> operator is a pipe operator for data transformation, check the topic of pip operator for learning its usage.</p>

<p>Service <code class="highlighter-rouge">apply</code> method takes a part for defining data processing flow, and response transformation if required. This single duty service will be composed to other higher abstraction level service such as:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">EmailSignUpService</span> <span class="nd">@Inject</span><span class="o">()(</span><span class="n">validateCaptcha</span><span class="k">:</span> <span class="kt">ValidateCaptchaService</span><span class="o">,</span>
                                   <span class="n">createEmailIdentity</span><span class="k">:</span> <span class="kt">CreateEmailIdentityService</span><span class="o">,</span>
                                   <span class="n">createEnterpriseEmailProfile</span><span class="k">:</span> <span class="kt">CreateEnterpriseEmailProfileService</span><span class="o">,</span>
                                   <span class="n">emailSignUpVerification</span><span class="k">:</span> <span class="kt">TokenVerificationService</span><span class="o">)</span>
    <span class="k">extends</span> <span class="nc">Logging</span> <span class="o">{</span>

  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">def</span> <span class="n">toCreateEmailIdentityRequest</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">InputEnterpriseEmailAccount</span><span class="o">)</span> <span class="k">=</span>
    <span class="nc">CreateEmailIdentityRequest</span><span class="o">(</span>
      <span class="n">password</span> <span class="k">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">value</span><span class="o">,</span>
      <span class="n">connectionId</span> <span class="k">=</span> <span class="nc">ConnectionId</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
    <span class="o">).|&gt;(</span><span class="n">p</span> <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">(</span><span class="nc">OK</span><span class="o">(</span><span class="n">p</span><span class="o">)))</span>

  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">def</span> <span class="n">toEnterpriseEmailProfile</span><span class="o">(</span><span class="n">response</span><span class="k">:</span> <span class="kt">CreateIdentityResponse</span><span class="o">,</span> <span class="n">account</span><span class="k">:</span> <span class="kt">InputEnterpriseEmailAccount</span><span class="o">)</span> <span class="k">=</span>
    <span class="nc">EnterpriseProfile</span><span class="o">(</span>
      <span class="n">id</span> <span class="k">=</span> <span class="n">response</span><span class="o">.</span><span class="n">accountId</span><span class="o">,</span>
      <span class="n">firstName</span> <span class="k">=</span> <span class="n">account</span><span class="o">.</span><span class="n">firstName</span><span class="o">,</span>
      <span class="n">lastName</span> <span class="k">=</span> <span class="n">account</span><span class="o">.</span><span class="n">lastName</span><span class="o">,</span>
      <span class="n">email</span> <span class="k">=</span> <span class="n">account</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">value</span>
    <span class="o">).|&gt;(</span><span class="n">p</span> <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">(</span><span class="nc">OK</span><span class="o">(</span><span class="n">p</span><span class="o">)))</span>

  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">def</span> <span class="n">toTokenVerificationRequest</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">AccountId</span><span class="o">,</span> <span class="n">req</span><span class="k">:</span> <span class="kt">EnterpriseEmailSignUpRequest</span><span class="o">)</span> <span class="k">=</span>
    <span class="nc">TokenVerificationRequest</span><span class="o">(</span><span class="n">topic</span> <span class="k">=</span> <span class="nc">EmailSignUp</span><span class="o">,</span>
                             <span class="n">accountId</span> <span class="k">=</span> <span class="n">id</span><span class="o">,</span>
                             <span class="n">languageCode</span> <span class="k">=</span> <span class="n">req</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">languageCode</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
      <span class="o">.|&gt;(</span><span class="n">p</span> <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">(</span><span class="nc">OK</span><span class="o">(</span><span class="n">p</span><span class="o">)))</span>

  <span class="k">private</span><span class="o">[</span><span class="kt">this</span><span class="o">]</span> <span class="k">def</span> <span class="n">toResponse</span><span class="o">(</span><span class="n">iResp</span><span class="k">:</span> <span class="kt">CreateIdentityResponse</span><span class="o">)</span> <span class="k">=</span>
    <span class="nc">EnterpriseEmailSignUpResponse</span><span class="o">(</span><span class="n">iResp</span><span class="o">.</span><span class="n">accountId</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">req</span><span class="k">:</span> <span class="kt">EnterpriseEmailSignUpRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Maybe</span><span class="o">[</span><span class="kt">EnterpriseEmailSignUpResponse</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="o">(</span><span class="k">for</span> <span class="o">{</span>
      <span class="k">_</span>                <span class="k">&lt;-</span> <span class="nc">FutureEither</span><span class="o">(</span><span class="n">validateCaptcha</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">captcha</span><span class="o">))</span>
      <span class="n">identityReq</span>      <span class="k">&lt;-</span> <span class="nc">FutureEither</span><span class="o">(</span><span class="n">toCreateEmailIdentityRequest</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">account</span><span class="o">))</span>
      <span class="n">identityResponse</span> <span class="k">&lt;-</span> <span class="nc">FutureEither</span><span class="o">(</span><span class="n">createEmailIdentity</span><span class="o">(</span><span class="n">identityReq</span><span class="o">))</span>
      <span class="n">profile</span>          <span class="k">&lt;-</span> <span class="nc">FutureEither</span><span class="o">(</span><span class="n">toEnterpriseEmailProfile</span><span class="o">(</span><span class="n">identityResponse</span><span class="o">,</span> <span class="n">req</span><span class="o">.</span><span class="n">account</span><span class="o">))</span>
      <span class="k">_</span>                <span class="k">&lt;-</span> <span class="nc">FutureEither</span><span class="o">(</span><span class="n">createEnterpriseEmailProfile</span><span class="o">(</span><span class="n">profile</span><span class="o">))</span>
      <span class="n">verifyReq</span>        <span class="k">&lt;-</span> <span class="nc">FutureEither</span><span class="o">(</span><span class="n">toTokenVerificationRequest</span><span class="o">(</span><span class="n">identityResponse</span><span class="o">.</span><span class="n">accountId</span><span class="o">,</span> <span class="n">req</span><span class="o">))</span>
      <span class="k">_</span>                <span class="k">&lt;-</span> <span class="nc">FutureEither</span><span class="o">(</span><span class="n">emailSignUpVerification</span><span class="o">(</span><span class="n">verifyReq</span><span class="o">))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">toResponse</span><span class="o">(</span><span class="n">identityResponse</span><span class="o">)).</span><span class="n">future</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">EmailSignUpService</code> is a highly abstraction for the business requirement. During each service transfer, the data type must reshape to another type in order to enter single duty services. By this mean, the data transformation will be controlled by <code class="highlighter-rouge">EmailSignUpService</code> and compose to a higher abstraction level service as its naming.</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/finatra-common-practice/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/finatra-common-practice/js/main.js"></script><script src="/finatra-common-practice/js/kazari.js"></script><script>
$(document).ready(function() {
	kazari.KazariPlugin().decorateCode('https://scala-evaluator-212.herokuapp.com/eval', 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.S2F6YXJp.Jl2eqMfw8IakJF93PjxTbrf-8YUJgX5OoOfy5JHE8Yw', '', 'monokai')
})
    </script></body></html>